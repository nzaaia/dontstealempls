<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Kechal Game</title>
  <meta name="theme-color" content="#0d1226">
  <meta name="description" content="Play Kechal card game with friends">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üÉè</text></svg>">
  <style>
    /* ALL YOUR CSS STYLES REMAIN EXACTLY THE SAME */
    :root {
      --pass-color: #66551d;
      --draw-color: #1d6625;
      --kechal-color: #5c1d1d;
      --kechal-active: #793e3e;
      --card-width: 35px;
      --card-height: 50px;
      --avatar-size: 70px;
      --player-font-size: 1.1rem;
      --button-font-size: 1.3rem;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #0d1226;
      color: white;
      text-align: center;
      padding: 0 10px;
      overflow-x: hidden;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    header {
      background: #251469;
      color: #e0d9d9;
      padding: 15px;
      font-size: 1.8rem;
      font-weight: bold;
      position: relative;
    }

    .header-controls {
      position: absolute;
      right: 15px;
      top: 50%;
      transform: translateY(-50%);
      display: flex;
      gap: 10px;
    }

    .header-btn {
      background: #444;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 8px 15px;
      font-size: 0.9rem;
      cursor: pointer;
    }

    .game-container {
      display: flex;
      flex-direction: column;
      flex: 1;
      max-width: 900px;
      margin: 0 auto;
      width: 100%;
    }

    .players-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 20px;
      margin: 25px 0;
      flex: 1;
    }

    .player {
      background: none;
      padding: 15px;
      border-radius: 8px;
      text-align: center;
      display: flex;
      flex-direction: column;
      justify-content: center;
      transition: all 0.3s ease;
    }

    .player.current-turn {
      background: rgba(255, 255, 255, 0.1);
      box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
      border: 2px solid gold;
    }

    .avatar {
      width: var(--avatar-size);
      height: var(--avatar-size);
      margin: 0 auto 8px;
      border: 3px solid #123;
      border-radius: 10px;
      background-size: cover;
      background-position: center;
      transition: all 0.3s ease;
    }

    .player.current-turn .avatar {
      border-color: gold;
      box-shadow: 0 0 15px 5px gold;
      transform: scale(1.05);
    }

    .player-name {
      margin: 8px 0;
      font-size: var(--player-font-size);
      cursor: pointer;
      min-height: 1.4rem;
      font-weight: bold;
    }

    .tableau {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 5px;
      margin-top: 8px;
      min-height: 55px;
      position: relative;
    }

    .card {
      width: var(--card-width);
      height: var(--card-height);
      border-radius: 5px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: bold;
      color: white;
      transition: all 0.5s ease;
      position: relative;
    }

    .card.stealing {
      position: fixed;
      z-index: 100;
      animation: slideCard 0.8s ease-in-out forwards;
      pointer-events: none;
    }

    @keyframes slideCard {
      0% {
        transform: scale(1) rotate(0deg);
        opacity: 1;
      }
      50% {
        transform: scale(1.2) rotate(5deg);
        opacity: 0.9;
      }
      100% {
        transform: translate(var(--target-x), var(--target-y)) scale(1) rotate(0deg);
        opacity: 1;
      }
    }

    .controls-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin: 15px 0 25px;
    }

    .main-controls {
      display: flex;
      gap: 25px;
      margin-bottom: 15px;
    }

    .game-button {
      padding: 15px 30px;
      font-size: var(--button-font-size);
      font-weight: bold;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      position: relative;
      transition: all 0.1s ease;
      box-shadow: 0 5px 0 rgba(0, 0, 0, 0.3);
      min-width: 120px;
    }

    .game-button:active {
      transform: translateY(5px);
      box-shadow: 0 0 0 rgba(0, 0, 0, 0.3);
    }

    #passBtn {
      background: var(--pass-color);
      color: white;
    }

    #drawBtn {
      background: var(--draw-color);
      color: white;
    }

    #kechalBtn {
      background: var(--kechal-color);
      color: white;
    }

    #kechalBtn.active {
      background: var(--kechal-active);
    }

    #deckInfo {
      margin: 15px;
      font-size: 1.3rem;
      font-weight: bold;
    }

    #leaderboard {
      background: #111;
      padding: 25px;
      border-radius: 10px;
      margin: 25px auto;
      max-width: 350px;
      display: none;
    }

    .leaderboard-item {
      display: flex;
      justify-content: space-between;
      margin: 12px 0;
      padding: 8px;
      border-radius: 5px;
      font-size: 1.1rem;
    }

    .leaderboard-item:nth-child(1) {
      background: gold;
      color: black;
      font-weight: bold;
    }

    .leaderboard-item:nth-child(2) {
      background: silver;
      color: black;
    }

    .leaderboard-item:nth-child(3) {
      background: #cd7f32;
      color: black;
    }

    .bonus-info {
      font-size: 0.9rem;
      margin-top: 5px;
      color: #4CAF50;
      font-weight: bold;
    }

    .bonus-highlight {
      background: #4CAF50;
      color: white;
      padding: 2px 6px;
      border-radius: 3px;
      margin-left: 5px;
      font-size: 0.8rem;
      font-weight: bold;
    }

    #reshuffleBtn {
      margin-top: 20px;
      padding: 12px 25px;
      font-size: 1.1rem;
      background: #444;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      box-shadow: 0 4px 0 rgba(0, 0, 0, 0.3);
      position: relative;
      transition: all 0.1s ease;
    }

    #reshuffleBtn:active {
      transform: translateY(4px);
      box-shadow: 0 0 0 rgba(0, 0, 0, 0.3);
    }

    /* Modal styles */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }

    .modal-content {
      background: #222;
      padding: 25px;
      border-radius: 10px;
      max-width: 90%;
      width: 450px;
      text-align: center;
      max-height: 90vh;
      overflow-y: auto;
    }

    .name-inputs {
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
      margin: 25px 0;
    }

    .name-input {
      padding: 10px;
      border-radius: 5px;
      border: 1px solid #555;
      background: #333;
      color: white;
      font-size: 1rem;
    }

    .modal-buttons {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin-top: 25px;
    }

    .modal-button {
      padding: 12px 25px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
      font-size: 1rem;
    }

    #saveNamesBtn {
      background: #1d6625;
      color: white;
    }

    #cancelNamesBtn {
      background: #66551d;
      color: white;
    }

    /* Busted popup */
    #bustedPopup {
      background: #5c1d1d;
      color: white;
      font-size: 2rem;
      font-weight: bold;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 0 25px rgba(255, 0, 0, 0.5);
    }

    /* Game Over popup */
    #gameOverPopup {
      background: #1d3d66;
      color: white;
      font-size: 1.8rem;
      font-weight: bold;
      padding: 25px;
      border-radius: 10px;
      box-shadow: 0 0 25px rgba(0, 100, 255, 0.5);
    }

    /* Player Setup */
    .player-setup {
      display: flex;
      flex-direction: column;
      gap: 15px;
      margin: 20px 0;
    }

    .player-count-selector {
      display: flex;
      justify-content: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .player-count-btn {
      padding: 10px 20px;
      background: #333;
      color: white;
      border: 2px solid #555;
      border-radius: 5px;
      cursor: pointer;
      font-size: 1.1rem;
    }

    .player-count-btn.active {
      background: #1d6625;
      border-color: #2ecc71;
    }

    /* Sound Toggle */
    #soundToggleBtn.muted {
      background: #5c1d1d;
    }

    /* Mobile responsiveness */
    @media (max-width: 768px) {
      :root {
        --card-width: 30px;
        --card-height: 45px;
        --avatar-size: 60px;
        --player-font-size: 1rem;
        --button-font-size: 1.1rem;
      }
      
      header {
        font-size: 1.5rem;
        padding: 12px;
      }
      
      .players-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 15px;
      }
      
      .player {
        padding: 12px;
      }
      
      .player-name {
        font-size: var(--player-font-size);
      }
      
      .main-controls {
        gap: 20px;
      }
      
      .game-button {
        padding: 12px 25px;
        font-size: var(--button-font-size);
        min-width: 100px;
      }
      
      #deckInfo {
        font-size: 1.1rem;
      }
      
      .header-controls {
        flex-direction: column;
        gap: 5px;
      }
      
      .header-btn {
        padding: 6px 12px;
        font-size: 0.8rem;
      }
    }

    @media (max-width: 480px) {
      :root {
        --card-width: 25px;
        --card-height: 40px;
        --avatar-size: 50px;
        --player-font-size: 0.9rem;
        --button-font-size: 1rem;
      }
      
      header {
        font-size: 1.3rem;
        padding: 10px;
      }
      
      .players-grid {
        gap: 10px;
      }
      
      .player {
        padding: 8px;
      }
      
      .main-controls {
        gap: 15px;
      }
      
      .game-button {
        padding: 10px 20px;
        font-size: var(--button-font-size);
        min-width: 90px;
      }
      
      .modal-content {
        width: 95%;
        padding: 20px;
      }
      
      #bustedPopup {
        font-size: 1.7rem;
        padding: 25px;
      }
      
      #gameOverPopup {
        font-size: 1.5rem;
        padding: 20px;
      }
    }

    /* Large screen scaling */
    @media (min-width: 1200px) {
      :root {
        --card-width: 40px;
        --card-height: 55px;
        --avatar-size: 80px;
        --player-font-size: 1.2rem;
        --button-font-size: 1.4rem;
      }
      
      .game-container {
        max-width: 1000px;
      }
      
      header {
        font-size: 2rem;
        padding: 20px;
      }
      
      .players-grid {
        gap: 25px;
        margin: 30px 0;
      }
      
      .player {
        padding: 20px;
      }
      
      .game-button {
        padding: 18px 35px;
      }
    }

    /* PWA specific styles */
    #installPrompt {
      display: none;
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: #333;
      color: white;
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.5);
      z-index: 1001;
      text-align: center;
    }

    #installBtn {
      background: #1d6625;
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 5px;
      margin-top: 10px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <header>
    Online Kechal
    <div class="header-controls">
      <button class="header-btn" id="soundToggleBtn">üîä Sound On</button>
      <button class="header-btn" id="editNamesBtn">Edit Names</button>
    </div>
  </header>

  <div class="game-container">
    <!-- Player Setup Screen -->
    <div class="modal" id="setupModal" style="display: flex;">
      <div class="modal-content">
        <h2>Game Setup</h2>
        <p>Select number of players:</p>
        <div class="player-count-selector">
          <button class="player-count-btn" data-count="2">2 Players</button>
          <button class="player-count-btn" data-count="3">3 Players</button>
          <button class="player-count-btn" data-count="4">4 Players</button>
          <button class="player-count-btn" data-count="5">5 Players</button>
          <button class="player-count-btn" data-count="6" class="active">6 Players</button>
        </div>
        
        <div class="name-inputs" id="setupNameInputs"></div>
        
        <div class="modal-buttons">
          <button id="startGameBtn" class="modal-button">Start Game</button>
        </div>
      </div>
    </div>

    <div class="players-grid" id="board"></div>
    
    <div class="controls-container">
      <div class="main-controls">
        <button id="passBtn" class="game-button">PASS</button>
        <button id="drawBtn" class="game-button">DRAW</button>
      </div>
      <button id="kechalBtn" class="game-button">KECHAL</button>
    </div>

    <div id="deckInfo">Cards remaining: 90</div>
    <div id="leaderboard"></div>
  </div>

  <!-- Name Editor Modal -->
  <div class="modal" id="nameEditorModal">
    <div class="modal-content">
      <h2>Edit Player Names</h2>
      <div class="name-inputs" id="nameInputs"></div>
      <div class="modal-buttons">
        <button id="saveNamesBtn" class="modal-button">Save Names</button>
        <button id="cancelNamesBtn" class="modal-button">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Busted Popup -->
  <div class="modal" id="bustedModal">
    <div class="modal-content" id="bustedPopup"></div>
  </div>

  <!-- Game Over Popup -->
  <div class="modal" id="gameOverModal">
    <div class="modal-content" id="gameOverPopup">
      Game Over!<br>
      <span style="font-size: 1.2rem;">See scoreboard below</span>
    </div>
  </div>

  <!-- PWA Install Prompt -->
  <div id="installPrompt">
    <p>Install Kechal Game for a better experience!</p>
    <button id="installBtn">Install</button>
  </div>

  <!-- Audio elements for sound effects -->
  <audio id="drawSound" preload="auto"></audio>
  <audio id="stealSound" preload="auto"></audio>
  <audio id="bustedSound" preload="auto"></audio>
  <audio id="gameOverSound" preload="auto"></audio>
  <audio id="passSound" preload="auto"></audio>

  <script>
    // Game state variables
    let players = [];
    let numberOfPlayers = 6;
    let currentPlayer = 0;
    let deck = [];
    let turnCards = [];
    let safeDraws = 0;
    let lastWinner = 0;
    let soundEnabled = true;

    // DOM elements
    const boardEl = document.getElementById("board");
    const passBtn = document.getElementById("passBtn");
    const drawBtn = document.getElementById("drawBtn");
    const kechalBtn = document.getElementById("kechalBtn");
    const deckInfo = document.getElementById("deckInfo");
    const leaderboardEl = document.getElementById("leaderboard");
    const nameEditorModal = document.getElementById("nameEditorModal");
    const nameInputs = document.getElementById("nameInputs");
    const setupNameInputs = document.getElementById("setupNameInputs");
    const saveNamesBtn = document.getElementById("saveNamesBtn");
    const cancelNamesBtn = document.getElementById("cancelNamesBtn");
    const editNamesBtn = document.getElementById("editNamesBtn");
    const soundToggleBtn = document.getElementById("soundToggleBtn");
    const bustedModal = document.getElementById("bustedModal");
    const bustedPopup = document.getElementById("bustedPopup");
    const gameOverModal = document.getElementById("gameOverModal");
    const setupModal = document.getElementById("setupModal");
    const startGameBtn = document.getElementById("startGameBtn");
    const playerCountBtns = document.querySelectorAll('.player-count-btn');

    // Avatar images
    const avatarImages = [
      'https://images.unsplash.com/photo-1514888286974-6c03e2ca1dba?w=150&h=150&fit=crop&crop=center',
      'https://images.unsplash.com/photo-1533738363-b7f9aef128ce?w=150&h=150&fit=crop&crop=center',
      'https://images.unsplash.com/photo-1495360010541-f48722b34f7d?w=150&h=150&fit=crop&crop=center',
      'https://images.unsplash.com/photo-1511044568932-338cba0ad803?w=150&h=150&fit=crop&crop=center',
      'https://images.unsplash.com/photo-1543852786-1cf6624b9987?w=150&h=150&fit=crop&crop=center',
      'https://images.unsplash.com/photo-1519052533468-317e06b9c9bf?w=150&h=150&fit=crop&crop=center'
    ];

    // Card colors
    const colors = {
      1: "red", 2: "teal", 3: "lightgreen", 4: "pink", 5: "purple",
      6: "orange", 7: "yellow", 8: "brown", 9: "blue", 10: "black"
    };

    // Sound functions
    function playSound(sound) {
      if (soundEnabled && sound) {
        try {
          sound.currentTime = 0;
          sound.play().catch(() => {});
        } catch (e) {}
      }
    }

    // Initialize game
    function initializePlayers(setupNames = []) {
      players = Array.from({length: numberOfPlayers}, (_, i) => ({
        name: setupNames[i] || `Player ${i+1}`,
        tableau: [],
        score: [],
        scoredCards: [],
        avatar: avatarImages[i % avatarImages.length]
      }));
    }

    function initDeck() {
      deck = [];
      
      // Create 90-card deck
      for (let n of [1, 2]) {
        for (let i = 0; i < 11; i++) deck.push(n);
      }
      for (let n of [6, 8]) {
        for (let i = 0; i < 7; i++) deck.push(n);
      }
      for (let i = 0; i < 10; i++) deck.push(10);
      for (let i = 0; i < 6; i++) deck.push(7);
      for (let i = 0; i < 5; i++) deck.push(9);
      
      deck = shuffle(deck);
      deckInfo.textContent = "Cards remaining: " + deck.length;
      leaderboardEl.style.display = "none";
      gameOverModal.style.display = "none";
      
      currentPlayer = 0;
      turnCards = [];
      safeDraws = 0;
    }

    function shuffle(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
      return array;
    }

    function render() {
      boardEl.innerHTML = "";
      
      for (let i = 0; i < numberOfPlayers; i++) {
        const p = players[i];
        const div = document.createElement("div");
        div.className = i === currentPlayer ? "player current-turn" : "player";
        div.innerHTML = `
          <div class="avatar" style="background-image: url('${p.avatar}')"></div>
          <div class="player-name" data-player-index="${i}">${p.name}${i===currentPlayer ? " (Your turn)" : ""}</div>
          <div class="tableau" id="tableau-${i}"></div>
        `;
        boardEl.appendChild(div);

        const tableauEl = div.querySelector(".tableau");
        p.tableau.forEach(card => {
          const c = document.createElement("div");
          c.className = "card";
          c.style.background = colors[card] || "gray";
          c.textContent = card;
          tableauEl.appendChild(c);
        });
      }
      deckInfo.textContent = "Cards remaining: " + deck.length;
    }

    function startTurn() {
      console.log("Starting turn for player:", currentPlayer);
      
      let p = players[currentPlayer];
      
      // Only score if player has cards AND it's not the very first turn
      if (p.tableau.length > 0) {
        console.log("Scoring cards for player:", currentPlayer, "cards:", p.tableau);
        const scoreResult = calculateScoreWithBonuses(p.tableau);
        p.score.push(scoreResult.total);
        p.scoredCards = p.scoredCards.concat(p.tableau);
        p.tableau = [];
      }
      
      turnCards = [];
      safeDraws = 0;
      kechalBtn.classList.remove("active");
      render();
    }

    function calculateScoreWithBonuses(tableau) {
      let baseScore = 0;
      const cardCounts = {};
      
      tableau.forEach(card => {
        cardCounts[card] = (cardCounts[card] || 0) + 1;
        baseScore += card;
      });
      
      let bonus = 0;
      let bonusDetails = [];
      
      if (cardCounts[1] >= 5) {
        bonus += 15;
        bonusDetails.push(`+15 for ${cardCounts[1]} ones`);
      }
      if (cardCounts[2] >= 5) {
        bonus += 6;
        bonusDetails.push(`+6 for ${cardCounts[2]} twos`);
      }
      
      return {
        base: baseScore,
        bonus: bonus,
        total: baseScore + bonus,
        bonusDetails: bonusDetails,
        cardCounts: cardCounts
      };
    }

    function drawCard() {
      console.log("Draw card called, deck length:", deck.length);
      
      if (deck.length === 0) {
        console.log("Deck empty, ending game");
        endGame();
        return;
      }
      
      const card = deck.pop();
      let p = players[currentPlayer];

      if (safeDraws >= 3 && p.tableau.includes(card)) {
        p.tableau.push(card);
        render();
        showBustedPopup(card);
        turnCards = [];
        endTurn(true);
        return;
      }

      turnCards.push(card);
      p.tableau.push(card);
      safeDraws++;

      let stealPossible = players.some((other, i) =>
        i !== currentPlayer && other.tableau.includes(card)
      );
      
      if (stealPossible) {
        kechalBtn.classList.add("active");
      } else {
        kechalBtn.classList.remove("active");
      }

      render();
    }

    function showBustedPopup(card) {
      bustedPopup.textContent = `BUSTED!! for ${card}`;
      bustedModal.style.display = "flex";
      
      setTimeout(() => {
        bustedModal.style.display = "none";
      }, 1500);
    }

    function passTurn() {
      console.log("Pass turn called, current player:", currentPlayer);
      
      if (deck.length === 0) {
        console.log("Deck empty after pass, ending game");
        endGame();
        return;
      }
      
      endTurn(false);
    }

    function endTurn(busted) {
      console.log("Ending turn for player:", currentPlayer, "busted:", busted);
      
      let p = players[currentPlayer];
      if (busted) {
        p.tableau = [];
      }
      
      turnCards = [];
      kechalBtn.classList.remove("active");
      
      // Move to next player
      currentPlayer = (currentPlayer + 1) % numberOfPlayers;
      console.log("Next player:", currentPlayer);
      
      startTurn();
    }

    function doKechal() {
      const lastCard = turnCards[turnCards.length-1];
      let stolenCards = [];
      
      players.forEach((other,i) => {
        if (i !== currentPlayer) {
          other.tableau.forEach(card => {
            if (card === lastCard) {
              stolenCards.push({card, fromPlayer: i});
            }
          });
        }
      });
      
      players.forEach((other,i) => {
        if (i !== currentPlayer) {
          other.tableau = other.tableau.filter(c => c !== lastCard);
        }
      });
      
      if (stolenCards.length > 0) {
        animateCardStealing(stolenCards);
      } else {
        render();
      }
      
      kechalBtn.classList.remove("active");
    }

    function animateCardStealing(stolenCards) {
      render();
      
      setTimeout(() => {
        const currentPlayerTableau = document.getElementById(`tableau-${currentPlayer}`);
        const currentPlayerRect = currentPlayerTableau.getBoundingClientRect();
        
        stolenCards.forEach((stolen, index) => {
          const tempCard = document.createElement("div");
          tempCard.className = "card stealing";
          tempCard.style.background = colors[stolen.card] || "gray";
          tempCard.textContent = stolen.card;
          
          const fromPlayerTableau = document.getElementById(`tableau-${stolen.fromPlayer}`);
          const fromPlayerRect = fromPlayerTableau.getBoundingClientRect();
          
          tempCard.style.position = "fixed";
          tempCard.style.left = `${fromPlayerRect.left + (fromPlayerRect.width / 2) - 17}px`;
          tempCard.style.top = `${fromPlayerRect.top + (fromPlayerRect.height / 2) - 25}px`;
          
          const targetX = currentPlayerRect.left + (currentPlayerRect.width / 2) - 17 - fromPlayerRect.left;
          const targetY = currentPlayerRect.top + (currentPlayerRect.height / 2) - 25 - fromPlayerRect.top;
          
          tempCard.style.setProperty('--target-x', `${targetX}px`);
          tempCard.style.setProperty('--target-y', `${targetY}px`);
          
          document.body.appendChild(tempCard);
          
          setTimeout(() => {
            players[currentPlayer].tableau.push(stolen.card);
            tempCard.remove();
            
            if (index === stolenCards.length - 1) {
              setTimeout(() => {
                render();
              }, 100);
            }
          }, 800);
        });
      }, 50);
    }

    function endGame() {
      console.log("Ending game, scoring all players");
      
      // Score all remaining cards
      players.forEach((player, index) => {
        if (player.tableau.length > 0) {
          console.log("Scoring final cards for player:", index, "cards:", player.tableau);
          const scoreResult = calculateScoreWithBonuses(player.tableau);
          player.score.push(scoreResult.total);
          player.scoredCards = player.scoredCards.concat(player.tableau);
          player.tableau = [];
        }
      });
      
      // Show game over popup
      gameOverModal.style.display = "flex";
      
      setTimeout(() => {
        gameOverModal.style.display = "none";
      }, 2000);
      
      // Calculate ranking
      let ranking = players.map((p, index) => {
        const totalScore = p.score.reduce((a, b) => a + b, 0);
        const finalBonusResult = calculateFinalBonuses(p.scoredCards);
        
        return {
          name: p.name,
          total: totalScore,
          index: index,
          bonusDetails: finalBonusResult.bonusDetails
        };
      });
      
      ranking.sort((a,b)=>b.total-a.total);
      lastWinner = ranking[0].index;

      // Show leaderboard
      leaderboardEl.style.display = "block";
      leaderboardEl.innerHTML = "<h3>Scoreboard</h3>";
      
      ranking.forEach((r,i) => {
        const item = document.createElement("div");
        item.className = "leaderboard-item";
        
        let bonusHTML = '';
        r.bonusDetails.forEach(bonus => {
          if (bonus.includes('+15')) {
            bonusHTML += '<span class="bonus-highlight">+15</span>';
          } else if (bonus.includes('+6')) {
            bonusHTML += '<span class="bonus-highlight">+6</span>';
          }
        });
        
        item.innerHTML = `
          <div>
            <div>${i+1}. ${r.name}</div>
            ${r.bonusDetails.length > 0 ? `<div class="bonus-info">${r.bonusDetails.join(', ')}</div>` : ''}
          </div>
          <div>
            <span>${r.total}</span>
            ${bonusHTML}
          </div>
        `;
        leaderboardEl.appendChild(item);
      });
      
      const reshuffleBtn = document.createElement("button");
      reshuffleBtn.id = "reshuffleBtn";
      reshuffleBtn.textContent = "Reshuffle";
      reshuffleBtn.addEventListener("click", restartGame);
      leaderboardEl.appendChild(reshuffleBtn);
    }

    function calculateFinalBonuses(allScoredCards) {
      const cardCounts = {};
      
      allScoredCards.forEach(card => {
        cardCounts[card] = (cardCounts[card] || 0) + 1;
      });
      
      let bonusDetails = [];
      
      if (cardCounts[1] >= 5) {
        bonusDetails.push(`+15 for ${cardCounts[1]} ones`);
      }
      if (cardCounts[2] >= 5) {
        bonusDetails.push(`+6 for ${cardCounts[2]} twos`);
      }
      
      return {
        bonusDetails: bonusDetails,
        cardCounts: cardCounts
      };
    }

    function restartGame() {
      const currentNames = players.map(p => p.name);
      setupModal.style.display = "flex";
      updateSetupNameInputs();
      
      setTimeout(() => {
        const inputs = setupNameInputs.querySelectorAll('.name-input');
        inputs.forEach((input, index) => {
          if (currentNames[index]) {
            input.value = currentNames[index];
          }
        });
      }, 100);
    }

    // Name editing functionality
    function openNameEditor() {
      nameInputs.innerHTML = '';
      players.forEach((player, index) => {
        const input = document.createElement('input');
        input.type = 'text';
        input.className = 'name-input';
        input.value = player.name;
        input.placeholder = `Player ${index + 1}`;
        input.dataset.playerIndex = index;
        nameInputs.appendChild(input);
      });
      nameEditorModal.style.display = 'flex';
    }

    function saveNames() {
      const inputs = nameInputs.querySelectorAll('.name-input');
      inputs.forEach(input => {
        const index = parseInt(input.dataset.playerIndex);
        if (input.value.trim() !== '') {
          players[index].name = input.value.trim();
        }
      });
      
      try {
        localStorage.setItem('kechalPlayers', JSON.stringify(players));
      } catch (e) {}
      
      nameEditorModal.style.display = 'none';
      render();
    }

    function updateSetupNameInputs() {
      setupNameInputs.innerHTML = '';
      for (let i = 0; i < numberOfPlayers; i++) {
        const input = document.createElement('input');
        input.type = 'text';
        input.className = 'name-input';
        const savedName = players[i] ? players[i].name : `Player ${i+1}`;
        input.value = savedName;
        input.placeholder = `Player ${i+1}`;
        input.dataset.playerIndex = i;
        setupNameInputs.appendChild(input);
      }
    }

    // Event listeners
    soundToggleBtn.addEventListener('click', () => {
      soundEnabled = !soundEnabled;
      soundToggleBtn.textContent = soundEnabled ? 'üîä Sound On' : 'üîá Sound Off';
      soundToggleBtn.classList.toggle('muted', !soundEnabled);
    });

    playerCountBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        playerCountBtns.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        numberOfPlayers = parseInt(btn.dataset.count);
        updateSetupNameInputs();
      });
    });

    startGameBtn.addEventListener('click', () => {
      const inputs = setupNameInputs.querySelectorAll('.name-input');
      const setupNames = [];
      inputs.forEach(input => {
        const index = parseInt(input.dataset.playerIndex);
        setupNames[index] = input.value.trim() || `Player ${index+1}`;
      });
      
      setupModal.style.display = 'none';
      initializePlayers(setupNames);
      initDeck();
      startTurn();
    });

    editNamesBtn.addEventListener('click', openNameEditor);
    saveNamesBtn.addEventListener('click', saveNames);
    cancelNamesBtn.addEventListener('click', () => {
      nameEditorModal.style.display = 'none';
    });

    passBtn.addEventListener("click", passTurn);
    drawBtn.addEventListener("click", drawCard);
    kechalBtn.addEventListener("click", doKechal);

    // Initialize
    updateSetupNameInputs();
  </script>
</body>
</html>